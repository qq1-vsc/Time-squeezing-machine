# 📚 完整修改和使用指南 | 执剑人系统 v2.0

## 🎯 本次更新内容

### ✨ 新增功能

#### 1️⃣ **数据持久化系统**
- ✅ 使用 SQLite 数据库自动保存所有计划
- ✅ 保存每个任务的执行记录（时间、专注度）
- ✅ 完整的历史数据追踪

#### 2️⃣ **继续上一次计划**
- ✅ 侧边栏显示最新计划
- ✅ 一键继续昨天/上次的计划
- ✅ 支持修改和重新优化

#### 3️⃣ **30天数据分析**
- ✅ 时间趋势图（计划 vs 实际）
- ✅ 专注度变化曲线
- ✅ 完成率统计
- ✅ 详细的数据指标

#### 4️⃣ **计划历史查询**
- ✅ 查看所有历史计划
- ✅ 每个计划的详细统计
- ✅ 一键导出 CSV 数据

---

## 🔧 技术修改详解

### 文件结构变化

```
Wallfacer System/
├── app_v2.py                  # ✨ 新增数据集成
├── data_manager.py            # ✨ 新增数据管理模块
├── requirements.txt           # ✅ 保持不变
├── README.md
├── GitHub上传教程.md           # ✨ 新增 GitHub 教程
├── run_v2.bat
├── .streamlit/
└── wallfacer_data.db          # ✨ 自动生成（数据库）
```

### 核心改动

#### 📄 `data_manager.py` (新文件)
- **表结构**：
  - `plans` - 存储优化后的计划
  - `task_records` - 存储任务执行记录
  - `daily_logs` - 存储日志汇总
- **关键函数**：
  ```python
  init_database()           # 初始化数据库
  save_plan()               # 保存计划
  save_task_record()        # 保存任务记录
  get_latest_plan()         # 获取最新计划
  get_today_plan()          # 获取今天计划
  get_statistics()          # 获取统计数据
  export_to_csv()           # 导出 CSV
  ```

#### 🎨 `app_v2.py` 改动
1. **导入数据管理模块**
   ```python
   from data_manager import (
       init_database, save_plan, save_task_record,
       get_latest_plan, get_today_plan, get_all_plans,
       get_plan_records, update_plan_status,
       get_statistics, export_to_csv
   )
   ```

2. **Session State 新增字段**
   ```python
   'current_plan_id'  # 存储当前计划 ID
   ```

3. **侧边栏新增功能**
   - 显示最新计划和今天计划
   - 一键继续功能

4. **数据自动保存点**
   - 点击"开始执行"时：保存计划 → 返回 plan_id
   - 点击"完成任务"时：保存任务记录
   - 所有任务完成时：更新计划状态为 'completed'

5. **数据分析 Tab 扩展**
   - Tab 3-1：今日统计（优先级分布、时间分布）
   - Tab 3-2：历史趋势（30天曲线图）
   - Tab 3-3：所有计划（计划列表、CSV导出）

---

## 🚀 使用流程

### 第一次使用

1. **启动应用**
   ```powershell
   cd "e:\Wallfacer System"
   streamlit run app_v2.py
   ```

2. **配置 API**
   - 在侧边栏输入 DeepSeek API Key
   - 点击"启动系统"

3. **输入计划**
   - 在"计划优化"tab 输入今日计划
   - 点击"疯狂优化"

4. **开始执行**
   - 确认计划无误
   - 点击"开始执行计划"
   - 系统自动保存计划到数据库

5. **实时执行**
   - 使用"完成当前任务"推进
   - 系统自动保存任务记录

### 第二天继续使用

**方案 1: 继续上一次**
- 打开应用
- 在侧边栏点击"▶️ 继续上一次"
- 或"▶️ 继续今天"

**方案 2: 查看数据分析**
- 打开"数据面板" Tab
- 查看历史趋势和完成率
- 导出 CSV 进行深度分析

---

## 📊 数据分析说明

### 三个分析维度

#### 1️⃣ 📈 今日统计
- 优先级分布（饼图）
- 时间分配（横向柱图）
- 关键指标（平均时间、专注度等）

#### 2️⃣ 📊 历史趋势（30天）
- **时间趋势图**
  - 蓝线：计划时间
  - 橙线：实际时间
  - 用来看是否按计划执行

- **专注度曲线**
  - 显示每天的平均专注度
  - 帮助调整难度和休息时间

- **完成率曲线**
  - 显示每天的任务完成率
  - 帮助评估计划可行性

#### 3️⃣ 📚 所有计划
- 计划列表（日期、状态、完成率）
- 导出 CSV（用 Excel 打开进行深度分析）

---

## 💾 数据库说明

### 自动生成的文件
```
wallfacer_data.db
├── plans 表
│   ├── id (主键)
│   ├── date (日期)
│   ├── title (计划标题)
│   ├── total_minutes (总时间)
│   ├── tasks_json (任务 JSON)
│   ├── status (状态: in_progress/completed)
│   └── created_at (创建时间)
│
├── task_records 表
│   ├── id (主键)
│   ├── plan_id (关联计划)
│   ├── task_name (任务名)
│   ├── scheduled_minutes (计划时间)
│   ├── actual_minutes (实际时间)
│   ├── focus_level (专注度 1-10)
│   ├── completed (是否完成)
│   ├── completed_at (完成时间)
│   └── notes (备注)
│
└── daily_logs 表
    ├── date (日期)
    ├── total_scheduled_minutes
    ├── total_actual_minutes
    ├── completion_rate
    ├── avg_focus_level
    └── notes
```

### 数据查询示例

**查看最近 7 天的数据：**
```python
import sqlite3
conn = sqlite3.connect('wallfacer_data.db')
cursor = conn.cursor()
cursor.execute('''
    SELECT date, total_scheduled_minutes, total_actual_minutes
    FROM task_records
    WHERE date >= date('now', '-7 days')
    ORDER BY date DESC
''')
results = cursor.fetchall()
```

---

## 🌐 GitHub 上传步骤

### 快速上传（5分钟）

1. **初始化 Git**
   ```powershell
   cd "e:\Wallfacer System"
   git init
   ```

2. **配置用户信息**
   ```powershell
   git config --global user.name "你的名字"
   git config --global user.email "你的邮箱"
   ```

3. **创建 .gitignore**
   ```powershell
   @"
   __pycache__/
   *.pyc
   .streamlit/secrets.toml
   wallfacer_data.db
   *.csv
   .env
   "@ | Out-File -Encoding UTF8 .gitignore
   ```

4. **第一次提交**
   ```powershell
   git add .
   git commit -m "初始化: 执剑人系统 v2.0 - 时间压榨机器"
   ```

5. **在 GitHub 创建仓库**
   - 访问 github.com
   - 创建新仓库 `wallfacer-system`
   - 复制 HTTPS 链接

6. **连接远程仓库**
   ```powershell
   git remote add origin https://github.com/你的用户名/wallfacer-system.git
   git branch -M main
   git push -u origin main
   ```

### 后续更新

每次修改后：
```powershell
git add .
git commit -m "功能: 添加某功能 | 修复某问题"
git push
```

---

## 🔍 数据导出和分析

### 导出 CSV
1. 打开应用 → 数据面板 → 所有计划
2. 点击"📥 导出数据为 CSV"
3. 下载文件

### 在 Excel 中分析
```
建议分析列:
- 日期趋势 → 用折线图展示
- 完成率 → 用面积图展示
- 专注度 → 用柱图展示
- 时间偏差 → 用散点图展示
```

---

## ⚙️ 高级配置

### 修改数据库路径
在 `data_manager.py` 第一行：
```python
DB_FILE = "你的自定义路径/wallfacer_data.db"
```

### 修改统计时间范围
在 `data_manager.py` `get_statistics()` 函数：
```python
# 改这行可以改变时间范围
WHERE date >= date('now', '-30 days')  # 改成 -7 days、-90 days 等
```

### 清空所有数据
```powershell
Remove-Item wallfacer_data.db
```

---

## 📝 常见问题

### Q1: 数据没有保存？
**A:** 检查数据库文件是否存在
```powershell
ls wallfacer_data.db
```
如果不存在，重新启动应用会自动创建。

### Q2: 历史数据图表不显示？
**A:** 需要至少 1-2 天的数据才能显示趋势。

### Q3: 如何备份数据？
**A:** 复制 `wallfacer_data.db` 文件到安全位置

### Q4: 导出的 CSV 乱码？
**A:** 已使用 UTF-8 编码，如 Excel 显示乱码，改用 UTF-8 BOM 打开

---

## 🎯 下一步建议

### 短期优化
- [ ] 添加任务标签系统
- [ ] 支持任务模板保存
- [ ] 实时通知提醒

### 中期优化
- [ ] 添加周/月/年报表
- [ ] AI 生成改进建议
- [ ] 多设备同步（云存储）

### 长期规划
- [ ] 移动端 APP（Flutter/React Native）
- [ ] 团队协作功能
- [ ] 数据可视化大屏

---

## 🚀 立即开始

1. **备份现有代码** (如有)
2. **启动新版本应用**
3. **输入计划并执行**
4. **查看数据分析**
5. **上传到 GitHub 分享**

---

**祝你效率提升！** ⚡

**"不要浪费每一秒，每一秒都是成长的机会"**
